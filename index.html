<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SUB Config Decoder ‚Äî PRO MODE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
--bg:#0b1020;--card:#151c2f;--accent:#5c7cff;--text:#e6eef8;
--muted:#94a3b8;--border:1px solid rgba(255,255,255,.08);
--success:#10b981;--error:#ef4444;--warning:#f59e0b;
}
[data-theme="light"]{
--bg:#f8fafc;--card:#fff;--accent:#4f46e5;--text:#1e293b;
--muted:#64748b;--border:1px solid rgba(0,0,0,.08)
}
*{box-sizing:border-box;font-family:Inter,Segoe UI, sans-serif}
body{margin:0;background:var(--bg);color:var(--text);padding:16px;min-height:100vh}
.container{max-width:1200px;margin:auto;display:grid;grid-template-columns:1fr 380px;gap:20px}
.card{background:var(--card);border-radius:16px;padding:20px;border:var(--border);box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);}
textarea,input,button{
background:rgba(0,0,0,0.2);color:var(--text);border-radius:10px;
border:var(--border);padding:12px;outline:none;transition:all 0.2s;
}
[data-theme="light"] textarea, [data-theme="light"] input {background: #f1f5f9;}

textarea{width:100%;height:150px;font-family:monospace;font-size:12px;resize:vertical}
input:focus, textarea:focus {border-color: var(--accent);}

button{cursor:pointer;background:var(--accent);border:none;font-weight:600;color:white}
button:hover{opacity:0.9;transform:translateY(-1px)}
button:active{transform:translateY(0)}
button.ghost{background:transparent;border:var(--border);color:var(--text)}
button.ghost:hover{background:rgba(255,255,255,0.05)}
[data-theme="light"] button.ghost:hover{background:rgba(0,0,0,0.05)}

.tabs{display:flex;gap:5px;margin-bottom:15px;background:rgba(0,0,0,0.2);padding:5px;border-radius:12px}
.tabs button{flex:1;background:transparent;color:var(--muted);padding:8px;border-radius:8px;font-size:13px}
.tabs button.active{background:var(--accent);color:white;box-shadow:0 2px 4px rgba(0,0,0,0.2)}

.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.small{font-size:13px;color:var(--muted)}
.counter span{margin-right:10px;font-family:monospace}

/* List View Styles */
.config-list {
    margin-top: 15px;
    height: 500px;
    overflow-y: auto;
    border: var(--border);
    border-radius: 12px;
    background: rgba(0,0,0,0.1);
}
.config-item {
    display: grid;
    grid-template-columns: 40px 1fr auto;
    gap: 10px;
    padding: 12px;
    border-bottom: var(--border);
    align-items: center;
    transition: background 0.2s;
}
.config-item:hover {background: rgba(255,255,255,0.03);}
.config-icon {
    width: 36px;
    height: 36px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: bold;
    color: var(--accent);
}
.config-details {overflow: hidden;}
.config-name {font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
.config-meta {font-size: 11px; color: var(--muted); margin-top: 2px; font-family: monospace;}

.ping-badge {
    min-width: 60px;
    text-align: center;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: bold;
    background: rgba(255,255,255,0.05);
    cursor: pointer;
}
.ping-badge.good {color: var(--success); background: rgba(16, 185, 129, 0.1);}
.ping-badge.med {color: var(--warning); background: rgba(245, 158, 11, 0.1);}
.ping-badge.bad {color: var(--error); background: rgba(239, 68, 68, 0.1);}
.ping-badge:hover {filter: brightness(1.2);}

.action-btn {padding: 6px; border-radius: 6px; background: transparent; border: var(--border);}

/* Happ Section */
.happ-box {
    margin-top: 20px;
    padding: 15px;
    background: linear-gradient(45deg, rgba(92, 124, 255, 0.1), transparent);
    border: 1px solid rgba(92, 124, 255, 0.2);
    border-radius: 12px;
}

@media(max-width:900px){
    .container{grid-template-columns:1fr}
    .config-list {height: 400px;}
}
</style>
</head>

<body>
<div class="container">

<!-- LEFT PANEL -->
<div class="card">
    <div class="row" style="justify-content: space-between; margin-bottom: 10px;">
        <h2>üöÄ Config Decoder <span style="font-size:12px; opacity:0.6; font-weight:400">v2.0</span></h2>
        <div class="row">
            <button class="ghost" onclick="testAllPings()">‚ö° Test All Pings</button>
            <button class="ghost" onclick="clearAll()">üóëÔ∏è Clear</button>
        </div>
    </div>

    <textarea id="sub" placeholder="Paste subscription URL (https://...) or Configs (vmess://, vless://...) or Base64 string here..."></textarea>
    
    <div class="row" style="margin-top:10px">
        <button onclick="generate()" style="flex:2">üîì Decode & Generate</button>
        <button class="ghost" onclick="copyRaw()" style="flex:1">üìã Copy Raw</button>
    </div>

    <div style="margin-top:20px">
        <div class="tabs">
            <button class="active" onclick="setTab('all')" id="tab-all">All</button>
            <button onclick="setTab('vmess')" id="tab-vmess">VMESS</button>
            <button onclick="setTab('vless')" id="tab-vless">VLESS</button>
            <button onclick="setTab('trojan')" id="tab-trojan">Trojan</button>
            <button onclick="setTab('ss')" id="tab-ss">SS</button>
        </div>
        
        <input id="search" placeholder="üîç Filter configs..." style="width:100%; margin-bottom:10px">
        
        <div id="output-list" class="config-list">
            <div style="padding:20px; text-align:center; color:var(--muted)">No configs loaded yet...</div>
        </div>
        
        <div class="row counter small" style="margin-top:10px; justify-content:space-between">
            <span id="cnt">Ready</span>
        </div>
    </div>
</div>

<!-- RIGHT PANEL -->
<div class="card">
    <div class="row" style="justify-content: space-between;">
        <strong>‚öô Utilities</strong>
        <button class="ghost" onclick="toggleTheme()" style="padding:5px 10px">üåô/‚òÄÔ∏è</button>
    </div>

    <!-- HAPP EXPORT SECTION -->
    <div class="happ-box">
        <h4 style="margin:0 0 10px 0; color: #60a5fa">üîπ Happ / Telegram Support</h4>
        <p class="small" style="margin-bottom:12px">Export configs with <b style="color:#fff">TheFachur</b> support tag.</p>
        
        <div style="display:grid; gap:8px">
            <button onclick="copyHappFormat()">üìã Copy for Happ</button>
            <button class="ghost" onclick="downloadHappFile()">üíæ Download .conf file</button>
        </div>
        <p class="small" style="margin-top:8px; font-size:11px; opacity:0.7">
            * Import the .conf file directly into Happ or paste the copied text.
        </p>
    </div>

    <hr style="border:0; border-top:var(--border); margin: 20px 0">

    <h4>üì¶ Regular Export</h4>
    <div class="row">
        <button class="ghost" onclick="downloadTXT()" style="flex:1">TXT</button>
        <button class="ghost" onclick="downloadJSON()" style="flex:1">JSON</button>
        <button class="ghost" onclick="downloadClash()" style="flex:1">Clash</button>
    </div>

    <h4 style="margin-top:20px">üïò History</h4>
    <div class="history small" id="history"></div>
</div>

</div>

<script>
/* --- CONFIGURATION --- */
const HAPP_SUPPORT_ID = "https://t.me/TheFachur";

/* --- STATE --- */
const subInput = document.getElementById("sub");
const outList = document.getElementById("output-list");
let allLines = [];
let parsedConfigs = []; // Stores objects {raw, type, alias, ip, port}
let currentTab = "all";

/* --- UTILS --- */
const isB64 = s => {try{return btoa(atob(s.replace(/\s+/g,'')))===s.replace(/\s+/g,'')}catch{return false}}
const dec = s => {try{return decodeURIComponent(escape(atob(s)))}catch{try{return atob(s)}catch{return null}}}

/* --- DECODERS --- */
function parseVmess(l) {
    try {
        let j = JSON.parse(atob(l.replace("vmess://", "")));
        return {
            type: 'vmess',
            alias: j.ps || "VMess",
            ip: j.add,
            port: j.port,
            raw: l,
            obj: j
        };
    } catch { return null; }
}

function parseUrlBased(l, type) {
    try {
        let u = new URL(l);
        return {
            type: type,
            alias: decodeURIComponent(u.hash.slice(1)) || type.toUpperCase(),
            ip: u.hostname,
            port: u.port,
            raw: l
        };
    } catch { return null; }
}

/* --- GENERATE LOGIC --- */
async function generate(){
    let v = subInput.value.trim(); 
    if(!v) return;
    
    // Auto-download if link
    if(v.startsWith("http")){
        const btn = document.querySelector('button[onclick="generate()"]');
        btn.innerText = "Downloading...";
        try {
            // Using a CORS proxy to bypass browser restrictions
            let r = await fetch(`https://corsproxy.io/?${encodeURIComponent(v)}`);
            if(!r.ok) throw new Error("Fetch failed");
            v = await r.text();
            saveHistory(subInput.value); // Save the URL
        } catch(e) {
            alert("Could not download link automatically. Please open the link in a new tab, copy the text content, and paste it here.");
            btn.innerText = "üîì Decode & Generate";
            return;
        }
        btn.innerText = "üîì Decode & Generate";
    } else {
        saveHistory(v.substring(0, 50) + "...");
    }

    // Attempt Base64 Decode of entire body
    if(!v.includes("://") && isB64(v)) {
        let d = dec(v);
        if(d) v = d;
    }

    let lines = v.split(/\r?\n/).filter(x => x.trim());
    parsedConfigs = [];

    lines.forEach(l => {
        l = l.trim();
        let p = null;
        if(l.startsWith("vmess://")) p = parseVmess(l);
        else if(l.startsWith("vless://")) p = parseUrlBased(l, "vless");
        else if(l.startsWith("trojan://")) p = parseUrlBased(l, "trojan");
        else if(l.startsWith("ss://")) p = parseUrlBased(l, "ss");
        
        if(p) parsedConfigs.push(p);
    });

    render();
}

/* --- RENDER UI --- */
function render() {
    let q = document.getElementById("search").value.toLowerCase();
    outList.innerHTML = "";
    
    let filtered = parsedConfigs.filter(c => {
        if(currentTab !== "all" && c.type !== currentTab) return false;
        return (c.alias + c.ip).toLowerCase().includes(q);
    });

    if(filtered.length === 0) {
        outList.innerHTML = `<div style="padding:20px; text-align:center; color:var(--muted)">No configs found.</div>`;
        return;
    }

    filtered.forEach((c, idx) => {
        let el = document.createElement("div");
        el.className = "config-item";
        el.innerHTML = `
            <div class="config-icon">${c.type.toUpperCase().slice(0,2)}</div>
            <div class="config-details">
                <div class="config-name" title="${c.alias}">${c.alias}</div>
                <div class="config-meta">${c.ip}:${c.port}</div>
            </div>
            <div style="display:flex; gap:5px; align-items:center">
                <div class="ping-badge" id="ping-${idx}" onclick="testPing('${c.ip}', ${c.port}, ${idx})">Test Ping</div>
                <button class="action-btn" onclick="copyOne('${c.raw}')">üìã</button>
            </div>
        `;
        outList.appendChild(el);
    });

    updateCounter(filtered.length);
}

function updateCounter(count) {
    let m = {vmess:0, vless:0, trojan:0, ss:0};
    parsedConfigs.forEach(c => m[c.type]++);
    document.getElementById("cnt").innerHTML = 
        `Total: <b>${count}</b> <span style="opacity:0.3">|</span> ` +
        `VM: ${m.vmess} VL: ${m.vless} TR: ${m.trojan} SS: ${m.ss}`;
}

/* --- PING FUNCTION (ESTIMATION) --- */
async function testPing(ip, port, idx) {
    let el = document.getElementById(`ping-${idx}`);
    el.innerText = "Wait...";
    el.className = "ping-badge";
    
    const start = performance.now();
    try {
        // We use fetch with no-cors. This is a TCP/HTTP connectivity check.
        // It's not ICMP, but estimates connection time to the server.
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000); // 3s timeout

        await fetch(`http://${ip}:${port}`, {
            mode: 'no-cors', 
            cache: 'no-cache',
            signal: controller.signal
        }).catch(e => {
            // Ignore protocol errors, we just want timing
            if(e.name === 'AbortError') throw e;
        });
        
        clearTimeout(timeoutId);
        const duration = Math.round(performance.now() - start);
        
        el.innerText = duration + "ms";
        if(duration < 500) el.classList.add("good");
        else if(duration < 1500) el.classList.add("med");
        else el.classList.add("bad");

    } catch (e) {
        el.innerText = "Timeout";
        el.classList.add("bad");
    }
}

async function testAllPings() {
    parsedConfigs.forEach((c, idx) => {
        // Add a slight delay between pings to avoid browser throttling
        setTimeout(() => {
            if(document.getElementById(`ping-${idx}`)) testPing(c.ip, c.port, idx);
        }, idx * 200);
    });
}

/* --- HAPP EXPORT LOGIC --- */
function getHappContent() {
    // 1. Header
    let content = `#support-url: ${HAPP_SUPPORT_ID}\n`;
    // 2. Add Configs
    content += parsedConfigs.map(c => c.raw).join('\n');
    return content;
}

function copyHappFormat() {
    const text = getHappContent();
    navigator.clipboard.writeText(text).then(() => {
        alert("‚úÖ Copied Happ format!\nHeader added: #support-url: " + HAPP_SUPPORT_ID);
    });
}

function downloadHappFile() {
    const text = getHappContent();
    const date = new Date().toISOString().slice(0,10);
    dl(text, `Happ_Config_${date}.conf`);
}

/* --- OTHER EXPORTS --- */
function copyRaw() {
    let text = parsedConfigs.map(c => c.raw).join('\n');
    navigator.clipboard.writeText(text);
}

function copyOne(txt) {
    navigator.clipboard.writeText(txt);
}

function downloadTXT() {
    dl(parsedConfigs.map(c => c.raw).join('\n'), "configs.txt");
}

function downloadJSON() {
    dl(JSON.stringify(parsedConfigs, null, 2), "configs.json");
}

function downloadClash() {
    let y = "proxies:\n";
    parsedConfigs.filter(c => c.type === 'vmess').forEach((c, i) => {
        // Simple clash generator for VMess
        y += `  - name: ${c.alias}\n    type: vmess\n    server: ${c.ip}\n    port: ${c.port}\n    uuid: ${c.obj.id}\n    alterId: 0\n    cipher: auto\n    tls: ${c.obj.tls === 'tls'}\n    network: ${c.obj.net}\n`;
        if(c.obj.net === 'ws') {
            y += `    ws-opts:\n      path: ${c.obj.path}\n      headers:\n        Host: ${c.obj.host}\n`;
        }
    });
    dl(y, "clash_vmess_only.yaml");
}

function dl(content, filename) {
    let a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([content], {type: "text/plain"}));
    a.download = filename;
    a.click();
}

/* --- TABS & SEARCH --- */
function setTab(t) {
    currentTab = t;
    document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-'+t).classList.add('active');
    render();
}
document.getElementById("search").oninput = render;

/* --- THEME & HISTORY --- */
function toggleTheme(){
    let t = document.documentElement.getAttribute("data-theme") === "light" ? "dark" : "light";
    document.documentElement.setAttribute("data-theme", t);
    localStorage.theme = t;
}
if(localStorage.theme) document.documentElement.setAttribute("data-theme", localStorage.theme);

function saveHistory(v){
    let h = JSON.parse(localStorage.history || "[]");
    h.unshift(v); 
    h = [...new Set(h)].slice(0, 5);
    localStorage.history = JSON.stringify(h); 
    loadHistory();
}

function loadHistory(){
    let h = JSON.parse(localStorage.history || "[]");
    let el = document.getElementById("history");
    el.innerHTML = "";
    h.forEach(x => {
        let d = document.createElement("div");
        d.textContent = x.length > 40 ? x.slice(0, 40) + "..." : x;
        d.style.padding = "8px";
        d.style.cursor = "pointer";
        d.style.borderBottom = "1px solid rgba(255,255,255,0.05)";
        d.onclick = () => { subInput.value = x; generate(); };
        el.appendChild(d);
    });
}
function clearAll() {
    subInput.value = "";
    parsedConfigs = [];
    render();
}
loadHistory();
</script>
</body>
</html>


